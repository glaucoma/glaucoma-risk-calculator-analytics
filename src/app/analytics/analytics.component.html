<button routerLink="/" mat-button>⇦ back</button>

<app-date-range [startDatetime]="selectedMoments[0].toDate()" [endDatetime]="selectedMoments[1].toDate()">
</app-date-range>

<div *ngIf="!pyAnalyticsData">
  <pre>
    {{not_found_date_range ? "Try a different date-range." : "Python API endpoint not working, see console."}}
  </pre>
</div>

<div fxLayout="row" style="padding: 30px 0" fxLayoutGap="20px" *ngIf="pyAnalyticsData">
  <!--  <div fxFlex="40">

  <form [formGroup]="group">
    <mat-form-field>
      <mat-placeholder>Start DateTime</mat-placeholder>
      <mat-datetimepicker-toggle [for]="datetimePicker" matSuffix></mat-datetimepicker-toggle>
      <mat-datetimepicker #datetimePicker type="datetime" openOnFocus="true" timeInterval="5"></mat-datetimepicker>
      <input matInput formControlName="start" [matDatetimepicker]="datetimePicker" required autocomplete="false">
    </mat-form-field>
  </form>-->
  <!--
  <label for="daterange">Datetime range (click, then¡ press 'Set' to modify):</label>
  <input [(ngModel)]="selectedMoments" [selectMode]="'range'"
         [owlDateTimeTrigger]="date_range_component" [owlDateTime]="date_range_component"
         style="width: 100%; color: cornflowerblue"
         id="daterange" matInput>
  <owl-date-time #date_range_component></owl-date-time>

</div>
  -->

  <!--
  <input [matDatepicker]="pickerStart" id="start" fxFlex="30">
  <mat-datepicker type="datetime" clockStep="5" #pickerStart></mat-datepicker>
  -->
  <div fxFlex="100" fxLayout="row">
    <div fxFlex="49">
      <p>Of the {{pyAnalyticsData.survey_count}} entries:</p>
      <dl>
        <dt>step 1 only</dt>
        <dd>{{pyAnalyticsData.step1_count}}</dd>

        <dt>step 2 only</dt>
        <dd>{{pyAnalyticsData.step2_count}}</dd>

        <dt>step 3 only</dt>
        <dd>{{pyAnalyticsData.step3_count}}</dd>

        <dt>some_combination</dt>
        <dd>{{pyAnalyticsData.some_combination}}</dd>

        <dt>finished all 3</dt>
        <dd>{{pyAnalyticsData.all_steps}}</dd>
      </dl>
    </div>
    <div fxFlex="49">
      <p>Some notable statistics:</p>
      <dl>
        <dt>completed the final step</dt>
        <dd>{{pyAnalyticsData.all_steps}}, i.e.: {{pyAnalyticsData.completed.toPrecision(5)}}%</dd>

        <dt>converted (provided their emails)</dt>
        <dd *ngIf="pyAnalyticsData.email_conversion">
          {{pyAnalyticsData.emails}}, i.e.: {{pyAnalyticsData.email_conversion.toPrecision(5)}}%
        </dd>
        <dd *ngIf="!pyAnalyticsData.email_conversion">234.000 &dagger;
          <p>&dagger;in OPSM event (Monday 11/03/2019 from 8:30AM to 3:30PM AEST)</p>
        </dd>
      </dl>
    </div>
  </div>
</div>


<div fxLayout="column">
  <div fxLayout="row" fxLayout.lt-sm="column" fxLayoutGap="20px"
       *ngIf="risk_res_table != null && risk_res_table.data.length" fxFlex>
    <mat-card fxFlex>
      <mat-card-title>Calculations</mat-card-title>
      <mat-card-content>
        <h1>{{step_2.count}}</h1>
      </mat-card-content>
    </mat-card>

    <mat-card fxFlex>
      <mat-card-title>Ethnic distribution</mat-card-title>
      <mat-card-content>
        <ngx-charts-pie-chart fxFlex [labels]="true" [results]="ethnicity_agg" [view]="view"
                              style="text-align: left">
        </ngx-charts-pie-chart>
      </mat-card-content>
    </mat-card>

    <mat-card fxFlex>
      <mat-card-title>Age distribution</mat-card-title>
      <mat-card-content>
        <ngx-charts-line-chart fxFlex [results]="age_distr"
                               [view]="view"
                               [yAxis]="true"></ngx-charts-line-chart>
      </mat-card-content>
    </mat-card>
  </div>

  <div fxLayout="row" fxLayout.lt-sm="column" fxLayoutGap="20px"
       style="padding: 30px 0;"
       *ngIf="step_2_multi_series != null" fxFlex>
    <mat-card fxFlex>
      <mat-card-title>Stratified risk (area chart)</mat-card-title>
      <mat-card-content>
        <ngx-charts-area-chart-normalized
          [results]="step_2_multi_series">
        </ngx-charts-area-chart-normalized>
      </mat-card-content>
    </mat-card>

    <mat-card fxFlex>
      <mat-card-title>Stratified risk (numbers)</mat-card-title>
      <mat-card-content>
        <h2 style="color: #AF667D">{{step_2.least}}</h2>
        <h2 style="color: #9BB5E6">{{step_2.average}}</h2>
        <h2 style="color: #B099B7">{{step_2.high}}</h2>
        <h2 style="color: #C4E7F5">{{step_2.greatest}}</h2>
      </mat-card-content>
    </mat-card>
  </div>

  <div fxLayout="row" fxLayout.lt-sm="column" fxLayoutGap="20px"
       style="padding: 30px 0;"
       *ngIf="step_2 != null" fxFlex>
    <mat-expansion-panel fxFlex *ngIf="row_wise_age != null">
      <mat-expansion-panel-header>
        <mat-panel-title>
          Stats for age
        </mat-panel-title>
        <mat-panel-description>
          Avg, max, &etc.
        </mat-panel-description>
      </mat-expansion-panel-header>

      <dl *ngFor="let column of row_wise_columns">
        <dt>{{column}}</dt>
        <dd>{{row_wise_age[column]}}</dd>
      </dl>
    </mat-expansion-panel>

    <mat-expansion-panel fxFlex *ngIf="row_wise_client_risk != null">
      <mat-expansion-panel-header>
        <mat-panel-title>
          Stats for client risk
        </mat-panel-title>
        <mat-panel-description>
          Avg, max, &etc.
        </mat-panel-description>
      </mat-expansion-panel-header>

      <dl *ngFor="let column of row_wise_columns">
        <dt>{{column}}</dt>
        <dd>{{row_wise_client_risk[column]}}</dd>
      </dl>
    </mat-expansion-panel>
  </div>
</div>

<div class="mat-elevation-z8" *ngIf="risk_res_table != null">
  <mat-tab-group selectedIndex="1">
    <mat-tab label="Step 1 & [maybe] step 3">
      <app-survey-data [dataSource]="survey_table"></app-survey-data>
    </mat-tab>
    <mat-tab label="Step 2">
      <app-risk-res-data [dataSource]="risk_res_table"></app-risk-res-data>
    </mat-tab>
    <mat-tab label="Joint steps 1&ndash;3"> TODO: show this</mat-tab>
  </mat-tab-group>
</div>
